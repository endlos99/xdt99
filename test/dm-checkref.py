#!/usr/bin/env python

import os
import shutil

from config import Dirs, Disks, Files, Masks
from utils import xdm, checkFilesEq


### Main test

def runtest():
    """compare extracted files to reference files"""

    # compare with reference files generated by TI Image tool
    shutil.copyfile(Disks.recsdis, Disks.work)
    for fn in [
            "V1", "V16", "V126", "V127", "V128", "V254", "V10R",
            "V64V", "V255V1", "V255V2", "V255V3", "V255V4", "V255V5",
            # NOTE: F1.tfi has incorrect record count
            "F16", "F127", "F128", "F129", "F254", "F255", "F64V", "F10R"
            ]:
        xdm(Disks.work, "-e", fn, "-t", "-o", Files.output)
        checkFilesEq("TIFiles", Files.output,
                     os.path.join(Dirs.refs, fn + ".tfi"), "PROGRAM",
                     Masks.TIFile)

    # compare with (corrected) reference files generated by Classic99
    for fn in [
            "V16", "V127", "V64V", "V10R", "F129", "F64V", "F10R"
            ]:
        xdm(Disks.work, "-e", fn, "-9", "-o", Files.output)
        checkFilesEq("v9t9", Files.output,
                     os.path.join(Dirs.refs, fn + ".v9t9"), "PROGRAM",
                     Masks.v9t9)
        xdm("-F", Files.output, "-9", "-o", Files.output)
        xdm(Disks.work, "-e", fn, "-o", Files.reference)
        checkFilesEq("v9t9", Files.output, Files.reference, "PROGRAM")

    # compare files extracted from fragmented image
    shutil.copyfile(Disks.frag, Disks.work)
    for fn in ["F1", "F6"]:
        xdm(Disks.work, "-e", fn, "-o", Files.output)
        checkFilesEq("Frag Disk", Files.output,
                     os.path.join(Dirs.refs, "FRAG" + fn), "DIS/VAR127")
    xdm(Disks.work, "-d", "F1")
    xdm(Disks.work, "-e", "F6", "-o", Files.output)
    checkFilesEq("Frag Disk", Files.output, os.path.join(Dirs.refs, "FRAGF6"),
                 "DIS/VAR127")
    shutil.copyfile(Disks.frag, Disks.work)
    xdm(Disks.work, "-a", Files.output, "-n", "COPY", "-f", "DIS/VAR127")
    xdm(Disks.work, "-e", "F1", "-o", Files.output)
    checkFilesEq("Frag Disk", Files.output, os.path.join(Dirs.refs, "FRAGF1"),
                 "DIS/VAR127")

    # cleanup
    os.remove(Files.output)
    os.remove(Disks.work)


if __name__ == "__main__":
    runtest()
